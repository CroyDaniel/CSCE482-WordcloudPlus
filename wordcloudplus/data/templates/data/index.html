<!DOCTYPE html>
<html lang="en">

<head>
	<title>WordCloud+</title>
	<meta charset="utf-8"></meta>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
	<meta name="viewport" content = "width=device-width, initial-scale=1.0"></meta>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta>
</head>

<body>
	{% load static %}
	<div>
		<h1>WordCloud+</h1>
		<img src="{% static 'images/wordcloudpluslogo.png' %}" alt="Lovingly crafted by George, Sam, Matt, and Dan" style="width:480px;height:360px;"></img>
	    <script type="text/javascript">
	    	var set1Counter = 2;
	    	var set2Counter = 2;
	    	var set3Counter = 2;
			var limit = 5;

		    function addInput(divName, set){
		    	if(set == 1){
		    		if (set1Counter == limit)  {
		            	alert("You have reached the limit of adding " + limit + " inputs");
			        }
			        else {
			            var newdiv = document.createElement('div');
			            newdiv.innerHTML = "Set " + set + " URL: <input type='text' name='firstAddresses' id='firstAddr" + (set1Counter + 1) + "' required> Time Range: <input type='text' name='years' id='year" + (set1Counter + 1) + "' required><br>";
			            document.getElementById(divName).appendChild(newdiv);
		    	        set1Counter++;
			        }
		    	}

		    	if(set == 2){
		    		if (set2Counter == limit)  {
		            	alert("You have reached the limit of adding " + limit + " inputs");
			        }
			        else {
			            var newdiv = document.createElement('div');
			            newdiv.innerHTML = "Set " + set + " URL: <input type='text' name='firstAddresses' id='firstAddr" + (set2Counter + 1) + "' required> Time Range: <input type='text' name='years' id='year" + (set2Counter + 1) + "' required><br>";
			            document.getElementById(divName).appendChild(newdiv);
		    	        set2Counter++;
			        }
		    	}

		    	if(set == 3){
					if (set3Counter == limit)  {
	            		alert("You have reached the limit of adding " + limit + " inputs");
			        }
			        else {
			            var newdiv = document.createElement('div');
			            newdiv.innerHTML = "Set " + set + " URL: <input type='text' name='firstAddresses' id='firstAddr" + (set3Counter + 1) + "' required> Time Range: <input type='text' name='years' id='year" + (set3Counter + 1) + "' required><br>";
			            document.getElementById(divName).appendChild(newdiv);
		    	        set3Counter++;
			        }
		    	}
		    }

		    function removeInput(divName, set){
		    	if (document.getElementById(divName).childElementCount >= 7) {
		    		document.getElementById(divName).removeChild(document.getElementById(divName).lastChild);

			    	if (set == 1) {
			    		set1Counter--;
			    	}
			    	else if (set == 2) {
			    		set2Counter--;
			    	}
			    	else if (set == 3) {
			    		set3Counter--;
			    	}
		    	}

		    }
	    </script>
		<form action="/" method="POST">
			ONLY FIRST 2 LINKS FOR EACH SET WORK aka adding Inputs will create more inputs. But they don't get passed anywhere. Mining.py is under HEAVY construction atm. 
			<div id="area1">
				<br>
				Area 1 URL: <input type="text" name="firstAddresses" id="firstAddr1" required></input>
				Time Range: <input type="text" name="years" id="year1" required></input>
				<br>
				Area 1 URL: <input type="text" name="firstAddresses" id="firstAddr2"></input>
				Time Range: <input type="text" name="years" id="year1"></input>
				<br>
			</div>
			<input type="button" value="Add another text input" onClick="addInput('area1', 1);"></input>
			<input type="button" value="Remove text input" onClick="removeInput('area1', 1);"></input>
			<br>
			<br>
			<div id="area2">
				Area 2 URL: <input type="text" name="secondAddresses" id="secondAddr1"></input>
				Time Range: <input type="text" name="years" id="year3"></input>
				<br>
				Area 2 URL: <input type="text" name="secondAddresses" id="secondAddr2"></input>
				Time Range: <input type="text" name="years" id="year1"></input>
				<br>
			</div>
			<input type="button" value="Add another text input" onClick="addInput('area2', 2);"></input>
			<input type="button" value="Remove text input" onClick="removeInput('area2', 2);"></input>
			<br>
			<br>
			<div id="area3">
				Area 3 URL: <input type="text" name="thirdAddresses" id="thirdAddr1"></input>
				Time Range: <input type="text" name="years" id="year5"></input>
				<br>
				Area 3 URL: <input type="text" name="thirdAddresses" id="thirdAddr2"></input>
				Time Range: <input type="text" name="years" id="year1"></input>
				<br>
			</div>
			<input type="button" value="Add another text input" onClick="addInput('area3', 3);"></input>
			<input type="button" value="Remove text input" onClick="removeInput('area3', 3);"></input>
			<br>
			<br>
			<input type="submit" value="Submit"></input></input>
		</form> 
		
		<form action="/" method="POST" enctype='multipart/form-data'>
			Document Upload: <input type="file" name="doc" id="doc"></input>
			<br>
			<input type="hidden" value="file_upload" name="file_upload"></input>
			<input type="submit" value="Submit"></input>
			<p id="feedback1" style="visibility:hidden"/>Got it! Please click on 'Create Wordcloud' and wait a few moments. </p>
		</form>
		<div id="createButtons"></div>
		<input class="slider" type="range" name="points" id="timeRange" value="1" min="1" max="1" style="width: 400px;visibility:hidden;"></input>
		<p id="feedback2"></p>
	</div>
	
	<script src="{% static 'js/d3.v3.min.js' %}"></script>
	<script src="{% static 'js/d3.layout.cloud.js' %}"></script>
	<script src="{% static 'js/d3.sample.js' %}"></script>
	<script type="text/javascript">
		function creating(time_period, year){
			var newdiv = document.getElementById('createButtons');
			newdiv.innerHTML += "<input type='submit' id='create" + time_period + "' value='" + time_period + "' onclick='create(" + time_period + ", " + year + ")'/>";
			document.getElementById("feedback1").style.visibility = "visible";
		}

	//Create a new instance of the word cloud visualisation
		var myWordCloud = wordCloud('body');
	
	//Create a new instance of the word cloud visualisation
		var post_processed_storage = "{{post_processed_storage}}"
		var timeslot_word_count = "{{timeslot_word_count}}"
		var timeslot_word_frequency = "{{timeslot_word_frequency}}"

	//Creates years_list array for organization/Timeline button
		var years = "{{years | safe}}";
		var years_list_string = years.replace(/\'/g, "").replace(/u/g, "").replace(/\[/g, "").replace(/\]/g, "").replace(/ +/g,"");
		var years_list = years_list_string.split(",");

		//remove duplicates
		var tmp = [];
	    tmp = years_list.filter(function(item, pos) {
    		return years_list.indexOf(item) == pos;
		})
	    years_list = tmp;
	    years_list.sort();

	    //for loop to make buttons for timeline
		for(var year = 1; year < years_list.length; ++year){
			creating(years_list[year], year);
		}

	//Processing/Parsing wordcounts/frequencies into JSON
		var post_processed_storage = "{{post_processed_storage}}";
		var post_processed_storage = post_processed_storage.replace(/&quot;/g,'"');
		post_processed_storage = '[' + post_processed_storage + ']';
		var post_processed_storage_JSON = JSON.parse(post_processed_storage);
		//console.log(post_processed_storage_JSON);

		var timeslot_word_counts = "{{timeslot_word_counts}}";
		var timeslot_word_counts = timeslot_word_counts.replace(/&quot;/g,'"');
		timeslot_word_counts = '[' + timeslot_word_counts + ']';
		var timeslot_word_counts_JSON = JSON.parse(timeslot_word_counts);
		console.log(timeslot_word_counts_JSON);

		var timeslot_word_freq = "{{timeslot_word_frequency}}";
		var timeslot_word_freq = timeslot_word_freq.replace(/&quot;/g,'"');
		timeslot_word_freq = '[' + timeslot_word_freq + ']';
		var timeslot_word_freq_JSON = JSON.parse(timeslot_word_freq);
		//console.log(timeslot_word_freq_JSON);

		//Sort word_count by highest
		var word_string_array = {};
		for(var key in timeslot_word_counts_JSON[0]){
			var array=[],obj=timeslot_word_counts_JSON[0][key];
			for(a in obj){
				array.push([a,obj[a]])
			}
			array.sort(function(a,b){return a[1] - b[1]});
			array.reverse();
			timeslot_word_counts_JSON[0][key] = array;

			word_string_array[key] = timeslot_word_counts_JSON[0][key].toString();
		}


		//CTRL+/ to test JSON
		// for(var key in timeslot_word_counts_JSON[0]) {
  //   		var obj = timeslot_word_counts_JSON[0][key];
		//     console.log(key);
		//     console.log(obj);
		// }
		// for(var key in timeslot_word_freq_JSON[0]){
		// 	var obj = timeslot_word_freq_JSON[0][key];
		// 	console.log(key);
		//     console.log(obj);
		// }

		//BOOP BOOOP BOOP
		//THE FOLLOWING IS HARDCODED FOR TESTING, ASSUMES 1995 is a YEAR ENTERED
		//var words_array = timeslot_word_counts[0].split(", ");
		
		//var words_array = post_processed_storage_JSON[0][1995]["area1"].toString().replace(/\[/g, "").replace(/\]/g, "").split(",");
		//console.log(words_array);

		//var obj1 = { };

		//for (var i = 0, j = words_array.length; i < j; i++) {
			//obj1[words_array[i]] = (obj1[words_array[i]] || 0) + 1;
		//}
		
		var all_words = [];
		for (var year in timeslot_word_counts_JSON[0]){
			all_words.push(timeslot_word_counts_JSON[0][year].map(function (d) { return {text: d[0], size: d[1]}; }));
		}
		
		var smallest_word_size = Number.MAX_SAFE_INTEGER;
		var biggest_word_size = 0;
		var unique_words_array = Array.from(new Set(words_array));

		for (var i = unique_words_array.length - 1; i >= 0; --i) {
			var importance = obj1[unique_words_array[i]] / unique_words_array.length;
			if (importance < .02) { 
			//if (obj1[unique_words_array[i]] < 5){
				obj1[unique_words_array[i]] = 0;
				unique_words_array.splice(i, 1);
			}else if (i >= 1){
				while ((obj1[unique_words_array[i-1]] - obj1[unique_words_array[i]]) > 35){
					obj1[unique_words_array[i-1]] = obj1[unique_words_array[i-1]]-5;
				}if (obj1[unique_words_array[i]] > biggest_word_size){
					biggest_word_size = obj1[unique_words_array[i]];
				}
				else if (obj1[unique_words_array[i]] < smallest_word_size) {
					smallest_word_size = obj1[unique_words_array[i]]; 
				}
			}
		}

		var r;

		if (smallest_word_size == biggest_word_size){
			r = (150) / (biggest_word_size);
		}else {
			r = (150) / (biggest_word_size - smallest_word_size);
		}
		for (var i = 0; i < unique_words_array.length; ++i){
			obj1[unique_words_array[i]] = (obj1[unique_words_array[i]])*r;
		}
		
		//var words = unique_words_array.map(function (d) { return {text: d, size: obj1[d]}; });
		

		//TODO: REFORMAT TO BE DYNAMIC
		// var all_words = [words1, words2, words3];
		// var all_percentages = [site1_percentage1, site2_percentage1, site1_percentage2, site2_percentage2, site1_percentage3, site2_percentage3];
		
		// $(".slider").on("input", function() {
		// 	if (this.value < 3){
		// 		showNewWords(this.value, myWordCloud, all_words[this.value-1], all_percentages[this.value*2 - 2], all_percentages[this.value*2-1])
		// 	}else if (this.value == 3){
		// 		showNewWords(this.value, myWordCloud, all_words[this.value-2], all_percentages[this.value*2 - 4], all_percentages[this.value*2-3])
		// 		showNewWords(this.value, myWordCloud, all_words[this.value-1], all_percentages[this.value*2 - 2], all_percentages[this.value*2-1])
		// 	}
		// });

		//console.log(words);
		//console.log(timeslot_word_freq_JSON[0][1995]["area1"]);
		//console.log(timeslot_word_counts_JSON[0][1995]);

		function create(time_period, year){
			document.getElementById("feedback2").innerHTML = "Working...";
			console.log(year);
			showNewWords(year, myWordCloud, all_words[year-1], timeslot_word_freq_JSON[0][time_period]["area1"], timeslot_word_freq_JSON[0][time_period]["area3"]);
		}
		
	</script>

</html>


