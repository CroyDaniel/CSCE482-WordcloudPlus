<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
<!DOCTYPE html>
<html lang="en">

<head>
	<title>WordCloud+</title>
	<meta charset="utf-8"></meta>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
	<meta name="viewport" content = "width=device-width, initial-scale=1.0"></meta>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta>
</head>

<body>
	{% load static %}
	<div>
		<h1>WordCloud+</h1>
		<img src="{% static 'images/wordcloudpluslogo.png' %}" alt="Lovingly crafted by George, Sam, Matt, and Dan" style="width:480px;height:360px;"></img>
	    <script type="text/javascript">
	    	var set1Counter = 2;
	    	var set2Counter = 2;
	    	var set3Counter = 2;
			var limit = 5;

		    function addInput(divName, set){
		    	if(set == 1){
		    		if (set1Counter == limit)  {
		            	alert("You have reached the limit of adding " + limit + " inputs");
			        }
			        else {
			            var newdiv = document.createElement('div');
			            newdiv.innerHTML = "Area " + set + " URL: <input type='text' name='firstAddresses' id='firstAddr" + (set1Counter + 1) + "' required> Time Range: <input type='text' name='years' id='year" + (set1Counter + 1) + "' required><br>";
			            document.getElementById(divName).appendChild(newdiv);
		    	        set1Counter++;
			        }
		    	}

		    	if(set == 2){
		    		if (set2Counter == limit)  {
		            	alert("You have reached the limit of adding " + limit + " inputs");
			        }
			        else {
			            var newdiv = document.createElement('div');
			            newdiv.innerHTML = "Area " + set + " URL: <input type='text' name='firstAddresses' id='firstAddr" + (set2Counter + 1) + "' required> Time Range: <input type='text' name='years' id='year" + (set2Counter + 1) + "' required><br>";
			            document.getElementById(divName).appendChild(newdiv);
		    	        set2Counter++;
			        }
		    	}

		    	if(set == 3){
					if (set3Counter == limit)  {
	            		alert("You have reached the limit of adding " + limit + " inputs");
			        }
			        else {
			            var newdiv = document.createElement('div');
			            newdiv.innerHTML = "Area " + set + " URL: <input type='text' name='firstAddresses' id='firstAddr" + (set3Counter + 1) + "' required> Time Range: <input type='text' name='years' id='year" + (set3Counter + 1) + "' required><br>";
			            document.getElementById(divName).appendChild(newdiv);
		    	        set3Counter++;
			        }
		    	}
		    }

		    function removeInput(divName, set){
		    	if (document.getElementById(divName).childElementCount >= 7) {
		    		document.getElementById(divName).removeChild(document.getElementById(divName).lastChild);

			    	if (set == 1) {
			    		set1Counter--;
			    	}
			    	else if (set == 2) {
			    		set2Counter--;
			    	}
			    	else if (set == 3) {
			    		set3Counter--;
			    	}
		    	}

		    }
	    </script>
		<form action="/" method="POST">
			<div id="area1">
				<br>
				Area 1 URL: <input type="text" name="firstAddresses" id="firstAddr1" required></input>
				Time Range: <input type="text" name="years" id="year1" required></input>
				<br>
				Area 1 URL: <input type="text" name="firstAddresses" id="firstAddr2"></input>
				Time Range: <input type="text" name="years" id="year1"></input>
				<br>
			</div>
			<input type="button" value="Add another text input" onClick="addInput('area1', 1);"></input>
			<input type="button" value="Remove text input" onClick="removeInput('area1', 1);"></input>
			<br>
			<br>
			<div id="area2">
				Area 2 URL: <input type="text" name="secondAddresses" id="secondAddr1"></input>
				Time Range: <input type="text" name="years" id="year3"></input>
				<br>
				Area 2 URL: <input type="text" name="secondAddresses" id="secondAddr2"></input>
				Time Range: <input type="text" name="years" id="year1"></input>
				<br>
			</div>
			<input type="button" value="Add another text input" onClick="addInput('area2', 2);"></input>
			<input type="button" value="Remove text input" onClick="removeInput('area2', 2);"></input>
			<br>
			<br>
			<div id="area3">
				Area 3 URL: <input type="text" name="thirdAddresses" id="thirdAddr1"></input>
				Time Range: <input type="text" name="years" id="year5"></input>
				<br>
				Area 3 URL: <input type="text" name="thirdAddresses" id="thirdAddr2"></input>
				Time Range: <input type="text" name="years" id="year1"></input>
				<br>
			</div>
			<input type="button" value="Add another text input" onClick="addInput('area3', 3);"></input>
			<input type="button" value="Remove text input" onClick="removeInput('area3', 3);"></input>
			<br>
			<br>
			<input type="submit" value="Submit"></input></input>
		</form> 
		
		<form action="/" method="POST" enctype='multipart/form-data'>
			Document Upload: <input type="file" name="doc" id="doc"></input>
			<br>
			<input type="hidden" value="file_upload" name="file_upload"></input>
			<input type="submit" value="Submit"></input>
			<p id="feedback1" style="visibility:hidden"/>Got it! Please click on 'Create Wordcloud' and wait a few moments. </p>
		</form>
		<div id="createButtons"></div>
		<input class="slider" type="range" name="points" id="timeRange" value="1" min="1" max="1" style="width: 400px;visibility:hidden;"></input>
		<p id="feedback2"></p>
	</div>
	
	<script src="{% static 'js/d3.v3.min.js' %}"></script>
	<script src="{% static 'js/d3.layout.cloud.js' %}"></script>
	<script src="{% static 'js/d3.sample.js' %}"></script>
	<script type="text/javascript">
		function creating(time_period, year){
			var newdiv = document.getElementById('createButtons');
			newdiv.innerHTML += "<input type='submit' id='create" + time_period + "' value='" + time_period + "' onclick='create(" + time_period + ", " + year + ")'/>";
			document.getElementById("feedback1").style.visibility = "visible";
		}

	//Create a new instance of the word cloud visualisation
		var myWordCloud = wordCloud('body');
	
		var timeslot_word_count = "{{timeslot_word_count}}"
		var timeslot_word_frequency = "{{timeslot_word_frequency}}"

	//Creates years_list array for organization/Timeline button
		var years = "{{years | safe}}";
		var years_list_string = years.replace(/\'/g, "").replace(/u/g, "").replace(/\[/g, "").replace(/\]/g, "").replace(/ +/g,"");
		var years_list = years_list_string.split(",");

		//remove duplicates
		var tmp = [];
	    tmp = years_list.filter(function(item, pos) {
    		return years_list.indexOf(item) == pos;
		})
	    years_list = tmp;
	    years_list.sort();

	    //for loop to make buttons for timeline
		for(var year = 0; year < years_list.length; ++year){
			if (years_list.length == 1) {
				break;
			};
			creating(years_list[year], year+1);
		}

	//Processing/Parsing wordcounts/frequencies into JSON
		var timeslot_word_counts = "{{timeslot_word_counts}}";
		var timeslot_word_counts = timeslot_word_counts.replace(/&quot;/g,'"');
		timeslot_word_counts = '[' + timeslot_word_counts + ']';
		var timeslot_word_counts_JSON = JSON.parse(timeslot_word_counts);
		//console.log(timeslot_word_counts_JSON);

		var timeslot_word_freq = "{{timeslot_word_frequency}}";
		var timeslot_word_freq = timeslot_word_freq.replace(/&quot;/g,'"');
		timeslot_word_freq = '[' + timeslot_word_freq + ']';
		var timeslot_word_freq_JSON = JSON.parse(timeslot_word_freq);
		//console.log(timeslot_word_freq_JSON);

		//Sort word_count by highest
		var word_string_array = {};
		for(var key in timeslot_word_counts_JSON[0]){
			var array=[],obj=timeslot_word_counts_JSON[0][key];
			for(a in obj){
				array.push([a,obj[a]])
			}
			array.sort(function(a,b){return a[1] - b[1]});
			array.reverse();
			timeslot_word_counts_JSON[0][key] = array;

			word_string_array[key] = timeslot_word_counts_JSON[0][key].toString();
		}

		for (var year in timeslot_word_counts_JSON[0]){
			var smallest_word_size = Number.MAX_SAFE_INTEGER;
			var biggest_word_size = 0;

			for (var word = timeslot_word_counts_JSON[0][year].length - 1; word >= 0; --word) {
				var importance = timeslot_word_counts_JSON[0][year][word][1] / timeslot_word_counts_JSON[0][year].length;
				if (importance < .05) { 
					timeslot_word_counts_JSON[0][year][word][1] = 0;
					timeslot_word_counts_JSON[0][year].splice(word, 1);
				}else if (word >= 1){
					while ((timeslot_word_counts_JSON[0][year][word-1][1] - timeslot_word_counts_JSON[0][year][word][1]) > 35){
						timeslot_word_counts_JSON[0][year][word-1][1] = timeslot_word_counts_JSON[0][year][word-1][1]-5;
					}if (timeslot_word_counts_JSON[0][year][word][1] > biggest_word_size){
						biggest_word_size = timeslot_word_counts_JSON[0][year][word][1];
					}
					else if (timeslot_word_counts_JSON[0][year][word][1] < smallest_word_size) {
						smallest_word_size = timeslot_word_counts_JSON[0][year][word][1]; 
					}
				}
			}

			var r;

			if (smallest_word_size == biggest_word_size){
				r = (100) / (biggest_word_size);
			}else {
				r = (100) / (biggest_word_size - smallest_word_size);
			}
			for (var i = 0; i < timeslot_word_counts_JSON[0][year].length; ++i){
				timeslot_word_counts_JSON[0][year][i][1] = timeslot_word_counts_JSON[0][year][i][1]*r;
			}
		}
		
		var all_words = [];
		for (var year in timeslot_word_counts_JSON[0]){
			all_words.push(timeslot_word_counts_JSON[0][year].map(function (d) { return {text: d[0], size: d[1]}; }));
		}

	
		$(".slider").on("input", function() {
			if (this.value < 3){
		 		showNewWords(this.value, myWordCloud, all_words[this.value-1], timeslot_word_freq_JSON[0][years_list[this.value]])
		 	}else if (this.value == 3){
		 		showNewWords(this.value, myWordCloud, all_words[this.value-2], timeslot_word_freq_JSON[0][years_list[this.value]])
		 		showNewWords(this.value, myWordCloud, all_words[this.value-1], timeslot_word_freq_JSON[0][years_list[this.value]])
		 	}
		});

		function create(time_period, year){
			document.getElementById("feedback2").innerHTML = "Working...";
			//document.getElementById("timeRange").style.visibility = "visible";
			document.getElementById("timeRange").max = year;
			showNewWords(year, myWordCloud, all_words[year-1], timeslot_word_freq_JSON[0][years_list[year-1]]);
			
		}
		
	</script>

</html>


